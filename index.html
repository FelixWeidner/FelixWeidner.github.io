<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloud Dateien & Passwort Manager</title>
  <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .collection-card {
      transition: transform 0.2s;
    }
    .collection-card:hover {
      transform: scale(1.05);
    }
    .password-item {
      transition: background-color 0.2s;
    }
    .password-item:hover {
      background-color: #2d3748;
    }
    .admin-only {
      border: 2px solid #f87171;
    }
    .hidden-admin {
      display: none !important;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">
  <div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4 text-center">Cloud</h1>

    <!-- Cloud Dateien Section (Steam-√§hnliches Overlay) -->
    <div id="collectionsList" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
      <!-- Kein Neue Kollektion Button mehr in der Liste -->
    </div>
  </div>

  <!-- Neues Kollektion Modal -->
  <div id="newCollectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold">Neue Kollektion</h2>
        <button id="closeNewCollectionModalBtn" class="text-gray-400 hover:text-gray-200">‚úï</button>
      </div>
      <div class="flex flex-col gap-4 mb-4">
        <input id="collectionNameInput" type="text" placeholder="Kollektionsname" class="p-2 border rounded bg-gray-700 text-white">
        <select id="collectionServiceSelect" class="p-2 border rounded bg-gray-700 text-white">
          <option value="">Cloud Service w√§hlen</option>
          <option value="googleDrive">Google Drive</option>
          <option value="iCloud">iCloud</option>
          <option value="oneDrive">OneDrive</option>
        </select>
        <div class="flex flex-col gap-2">
          <select id="mainCategorySelect" class="p-2 border rounded bg-gray-700 text-white" onchange="updateSubcategoryDropdown('new')">
            <option value="">Hauptkategorie w√§hlen</option>
          </select>
          <select id="subCategorySelect" class="p-2 border rounded bg-gray-700 text-white">
            <option value="">Unterkategorie w√§hlen</option>
          </select>
          <input id="newMainCategoryInput" type="text" placeholder="Neue Hauptkategorie (optional)" class="p-2 border rounded bg-gray-700 text-white">
          <input id="newSubCategoryInput" type="text" placeholder="Neue Unterkategorie (optional)" class="p-2 border rounded bg-gray-700 text-white">
          <div id="mainCategoryAdminOnlyContainer" class="flex items-center hidden">
            <input type="checkbox" id="mainCategoryAdminOnlyCheckbox" class="mr-2">
            <label for="mainCategoryAdminOnlyCheckbox" class="text-white">Hauptkategorie nur f√ºr Admin</label>
          </div>
        </div>
        <input id="googleDriveLinkInput" type="text" placeholder="Google Drive/OneDrive Link (optional)" class="p-2 border rounded bg-gray-700 text-white">
        <input id="accessCodeInputNew" type="text" placeholder="Zugriffscode f√ºr Nicht-Admins (optional)" class="p-2 border rounded bg-gray-700 text-white">
        <div id="isAdminOnlyContainer" class="flex items-center">
          <input type="checkbox" id="isAdminOnlyCheckbox" class="mr-2">
          <label for="isAdminOnlyCheckbox" class="text-white">Kollektion nur f√ºr Admin</label>
        </div>
        <button id="createCollectionBtn" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Erstellen</button>
      </div>
    </div>
  </div>

  <!-- Kollektion Bearbeiten Modal -->
  <div id="editCollectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold">Kollektion Bearbeiten</h2>
        <button id="closeEditCollectionModalBtn" class="text-gray-400 hover:text-gray-200">‚úï</button>
      </div>
      <div class="flex flex-col gap-4 mb-4">
        <input id="editCollectionNameInput" type="text" placeholder="Kollektionsname" class="p-2 border rounded bg-gray-700 text-white">
        <select id="editCollectionServiceSelect" class="p-2 border rounded bg-gray-700 text-white">
          <option value="">Cloud Service w√§hlen</option>
          <option value="googleDrive">Google Drive</option>
          <option value="iCloud">iCloud</option>
          <option value="oneDrive">OneDrive</option>
        </select>
        <div class="flex flex-col gap-2">
          <select id="editMainCategorySelect" class="p-2 border rounded bg-gray-700 text-white" onchange="updateSubcategoryDropdown('edit')">
            <option value="">Hauptkategorie w√§hlen</option>
          </select>
          <select id="editSubCategorySelect" class="p-2 border rounded bg-gray-700 text-white">
            <option value="">Unterkategorie w√§hlen</option>
          </select>
          <input disposing id="editNewMainCategoryInput" type="text" placeholder="Neue Hauptkategorie (optional)" class="p-2 border rounded bg-gray-700 text-white">
          <input id="editNewSubCategoryInput" type="text" placeholder="Neue Unterkategorie (optional)" class="p-2 border rounded bg-gray-700 text-white">
          <div id="editMainCategoryAdminOnlyContainer" class="flex items-center hidden">
            <input type="checkbox" id="editMainCategoryAdminOnlyCheckbox" class="mr-2">
            <label for="editMainCategoryAdminOnlyCheckbox" class="text-white">Hauptkategorie nur f√ºr Admin</label>
          </div>
        </div>
        <input id="editGoogleDriveLinkInput" type="text" placeholder="Google Drive/OneDrive Link (optional)" class="p-2 border rounded bg-gray-700 text-white">
        <input id="editCollectionImageInput" type="file" accept="image/*" class="p-2 border rounded bg-gray-700 text-white">
        <input id="editAccessCodeInput" type="text" placeholder="Zugriffscode f√ºr Nicht-Admins (optional)" class="p-2 border rounded bg-gray-700 text-white">
        <div id="editIsAdminOnlyContainer" class="flex items-center">
          <input type="checkbox" id="editIsAdminOnlyCheckbox" class="mr-2">
          <label for="editIsAdminOnlyCheckbox" class="text-white">Kollektion nur f√ºr Admin</label>
        </div>
        <button id="saveCollectionBtn" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold">Admin Login</h2>
        <button id="closeLoginModalBtn" class="text-gray-400 hover:text-gray-200">‚úï</button>
      </div>
      <div class="flex flex-col gap-4 mb-4">
        <input id="loginUsernameInput" type="text" placeholder="Benutzername" class="p-2 border rounded bg-gray-700 text-white">
        <input id="loginPasswordInput" type="password" placeholder="Passwort" class="p-2 border rounded bg-gray-700 text-white">
        <button id="loginBtn" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Anmelden</button>
      </div>
    </div>
  </div>

  <!-- Access Code Modal -->
  <div id="accessCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold">Zugriffscode eingeben</h2>
        <button id="closeAccessCodeModalBtn" class="text-gray-400 hover:text-gray-200">‚úï</button>
      </div>
      <div class="flex flex-col gap-4 mb-4">
        <input id="accessCodeInput" type="text" placeholder="Zugriffscode" class="p-2 border rounded bg-gray-700 text-white">
        <button id="submitAccessCodeBtn" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Best√§tigen</button>
      </div>
    </div>
  </div>

  <!-- Admin Buttons (Passwort Manager, Neue Kollektion, Export, Import) -->
  <div id="adminButtons" class="fixed bottom-4 right-4 flex gap-4 hidden">
    <button id="openPasswordManagerBtn" class="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 shadow-lg">
      üîí
    </button>
    <button id="openNewCollectionBtn" class="bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 shadow-lg">
      ‚ûï
    </button>
    <button id="exportLocalStorageBtn" class="bg-green-500 text-white p-3 rounded-full hover:bg-green-600 shadow-lg" title="Export localStorage Data">
      üì§
    </button>
    <button id="importLocalStorageBtn" class="bg-purple-500 text-white p-3 rounded-full hover:bg-purple-600 shadow-lg" title="Import localStorage Data">
      üì•
    </button>
  </div>

  <!-- Passwort Manager Popup -->
  <div id="passwordManagerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white text-gray-900 p-6 rounded-lg w-full max-w-2xl shadow-lg">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">Passwort Manager</h2>
        <button id="closePasswordManagerBtn" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div class="mb-4">
        <input id="searchCredentials" type="text" placeholder="Suche Anmeldeinformationen..." class="w-full p-2 border rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div class="flex gap-4 mb-4">
        <select id="serviceInput" class="p-2 border rounded-lg bg-gray-100 text-gray-900 flex-1">
          <option value="">Cloud Service w√§hlen</option>
          <option value="googleDrive">Google Drive</option>
          <option value="iCloud">iCloud</option>
          <option value="oneDrive">OneDrive</option>
        </select>
        <input id="usernameInput" type="text" placeholder="Benutzername" class="p-2 border rounded-lg bg-gray-100 text-gray-900 flex-1">
        <input id="passwordInput" type="password" placeholder="Passwort" class="p-2 border rounded-lg bg-gray-100 text-gray-900 flex-1">
        <button id="addCredentialBtn" class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">Hinzuf√ºgen</button>
      </div>
      <div id="credentialList" class="max-h-96 overflow-y-auto bg-gray-50 rounded-lg p-2">
        <!-- Anmeldeinformationen werden hier dynamisch eingef√ºgt -->
      </div>
    </div>
  </div>

  <script>
    // Simulierte Cloud-Daten f√ºr verschiedene Accounts
    const cloudFiles = {
      googleDrive: {
        "user1@gmail.com": [
          { name: "Dokument1.pdf", size: "1.2 MB", url: "#" },
          { name: "Foto1.jpg", size: "3.5 MB", url: "#" },
        ],
        "user2@gmail.com": [
          { name: "Pr√§sentation.pdf", size: "2.0 MB", url: "#" },
          { name: "Video1.mp4", size: "15 MB", url: "#" },
        ],
      },
      iCloud: {
        "user1@icloud.com": [
          { name: "Notizen.txt", size: "0.1 MB", url: "#" },
          { name: "Foto2.jpg", size: "4.0 MB", url: "#" },
        ],
        "user2@icloud.com": [
          { name: "Backup.zip", size: "10 MB", url: "#" },
        ],
      },
      oneDrive: {
        "user1@onedrive.com": [
          { name: "Bericht.docx", size: "0.8 MB", url: "#" },
          { name: "Pr√§sentation.pptx", size: "5.0 MB", url: "#" },
        ],
        "user2@onedrive.com": [
          { name: "Projektplan.xlsx", size: "1.5 MB", url: "#" },
        ],
      },
    };

    // Einfache Verschl√ºsselung f√ºr Passwort-Manager (Base64 f√ºr Demo-Zwecke)
    const encrypt = (text) => btoa(text);
    const decrypt = (text) => atob(text);

    // Funktion zum Konvertieren eines Google Drive- oder OneDrive-Links in einen direkten Download-Link
    const convertCloudLink = (link, service) => {
      if (service === "googleDrive") {
        const fileIdMatch = link.match(/\/d\/(.+?)\//);
        if (fileIdMatch && fileIdMatch[1]) {
          return `https://drive.google.com/uc?export=download&id=${fileIdMatch[1]}`;
        }
      } else if (service === "oneDrive") {
        const fileIdMatch = link.match(/\/d\/(.+?)\//) || link.match(/\/file\/(.+?)\//);
        if (fileIdMatch && fileIdMatch[1]) {
          return link.replace(/\/d\//, "/download/").replace(/\/file\//, "/download/");
        }
      }
      return link; // Fallback, wenn der Link nicht erkannt wird
    };

    // Authentifizierungsstatus
    let isAuthenticated = false;

    // Funktion zum Laden der Kategorien aus localStorage
    const loadCategories = () => {
      return JSON.parse(localStorage.getItem("categories") || '[{"name": "", "subcategories": [], "isAdminOnly": false}]');
    };

    // Funktion zum Speichern einer neuen Kategorie oder Unterkategorie
    const saveCategory = (mainCategory, subCategory, isAdminOnly) => {
      if (!mainCategory && !subCategory) return;
      let categories = loadCategories();
      if (mainCategory) {
        let existingCategory = categories.find(cat => cat.name === mainCategory);
        if (!existingCategory) {
          categories.push({ name: mainCategory, subcategories: [], isAdminOnly: isAdminOnly || false });
          existingCategory = categories[categories.length - 1];
        } else if (isAuthenticated) {
          existingCategory.isAdminOnly = isAdminOnly || existingCategory.isAdminOnly;
        }
        if (subCategory && !existingCategory.subcategories.includes(subCategory)) {
          existingCategory.subcategories.push(subCategory);
        }
      }
      localStorage.setItem("categories", JSON.stringify(categories));
    };

    // Funktion zum Aktualisieren der Kategorie-Dropdowns
    const updateCategoryDropdowns = (modalType) => {
      const categories = loadCategories();
      const mainSelect = modalType === 'new' ? document.getElementById("mainCategorySelect") : document.getElementById("editMainCategorySelect");
      const subSelect = modalType === 'new' ? document.getElementById("subCategorySelect") : document.getElementById("editSubCategorySelect");

      mainSelect.innerHTML = '<option value="">Hauptkategorie w√§hlen</option>';
      subSelect.innerHTML = '<option value="">Unterkategorie w√§hlen</option>';

      categories.forEach(category => {
        if (category.name && (!category.isAdminOnly || isAuthenticated)) {
          const option = document.createElement("option");
          option.value = category.name;
          option.textContent = category.name + (category.isAdminOnly ? " (Admin Only)" : "");
          mainSelect.appendChild(option);
        }
      });
      updateSubcategoryDropdown(modalType);
    };

    // Funktion zum Aktualisieren der Unterkategorie-Dropdowns
    window.updateSubcategoryDropdown = (modalType) => {
      const mainSelect = modalType === 'new' ? document.getElementById("mainCategorySelect") : document.getElementById("editMainCategorySelect");
      const subSelect = modalType === 'new' ? document.getElementById("subCategorySelect") : document.getElementById("editSubCategorySelect");
      const categories = loadCategories();
      const selectedMain = mainSelect.value;

      subSelect.innerHTML = '<option value="">Unterkategorie w√§hlen</option>';
      if (selectedMain) {
        const category = categories.find(cat => cat.name === selectedMain);
        if (category && category.subcategories.length > 0) {
          category.subcategories.forEach(sub => {
            const option = document.createElement("option");
            option.value = sub;
            option.textContent = sub;
            subSelect.appendChild(option);
          });
        }
      }
    };

    // Kollektionen speichern
    const saveCollection = (name, service, cloudLink, mainCategory, subCategory, isCollectionAdminOnly, accessCode) => {
      const mainCategoryAdminOnly = document.getElementById("mainCategoryAdminOnlyCheckbox").checked;
      saveCategory(mainCategory, subCategory, mainCategoryAdminOnly);
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      collections.push({ 
        name, 
        service, 
        googleDriveLink: cloudLink ? convertCloudLink(cloudLink, service) : null, 
        image: null, 
        isAdminOnly: isCollectionAdminOnly || false, 
        mainCategory: mainCategory || "", 
        subCategory: subCategory || "", 
        accessCode: accessCode || null 
      });
      localStorage.setItem("collections", JSON.stringify(collections));
      updateCategoryDropdowns('new');
      displayCollections();
    };

    // Kollektion aktualisieren
    const updateCollection = (index, name, service, cloudLink, image, isAdminOnly, mainCategory, subCategory, accessCode) => {
      const mainCategoryAdminOnly = document.getElementById("editMainCategoryAdminOnlyCheckbox").checked;
      saveCategory(mainCategory, subCategory, mainCategoryAdminOnly);
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      collections[index] = { 
        name, 
        service, 
        googleDriveLink: cloudLink ? convertCloudLink(cloudLink, service) : null, 
        image, 
        isAdminOnly: isAdminOnly || false, 
        mainCategory: mainCategory || "", 
        subCategory: subCategory || "", 
        accessCode: accessCode || null 
      };
      localStorage.setItem("collections", JSON.stringify(collections));
      updateCategoryDropdowns('edit');
      displayCollections();
    };

    // Kollektionen anzeigen
    const displayCollections = () => {
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      const collectionsList = document.getElementById("collectionsList");
      collectionsList.innerHTML = "";

      collections.forEach((collection, index) => {
        const categories = loadCategories();
        const mainCategory = categories.find(cat => cat.name === collection.mainCategory);
        const isAdminLocked = collection.isAdminOnly || (mainCategory && mainCategory.isAdminOnly);

        // Nur Kollektionen anzeigen, die nicht admin-gesperrt sind oder f√ºr authentifizierte Admins
        if (!isAdminLocked || isAuthenticated) {
          const files = getFilesForCollection(collection.service);
          const div = document.createElement("div");
          div.className = `collection-card bg-gray-800 p-4 rounded-lg dynamic-collection ${collection.isAdminOnly ? 'admin-only' : ''}`;
          const imageSrc = collection.image || `https://via.placeholder.com/150x200?text=${collection.name}`;
          div.innerHTML = `
            <img src="${imageSrc}" alt="${collection.name}" class="w-full h-40 object-cover rounded">
            <p class="mt-2 text-center uppercase font-semibold">${collection.name}</p>
            <p class="text-center text-gray-400 text-sm">${collection.mainCategory ? collection.mainCategory + (collection.subCategory ? ' > ' + collection.subCategory : '') : ''}</p>
            <p class="text-center text-gray-400">(${files.length})</p>
            ${collection.isAdminOnly ? '<p class="text-center text-red-500 text-sm">Nur f√ºr Admin</p>' : ''}
            ${!isAdminLocked && collection.accessCode && !isAuthenticated ? '<p class="text-center text-yellow-500 text-sm">Zugriffscode erforderlich</p>' : ''}
          `;
          collectionsList.appendChild(div);

          div.addEventListener("click", () => {
            if (!isAuthenticated && isAdminLocked) {
              alert("Nur authentifizierte Admins k√∂nnen auf diese Kollektion zugreifen!");
              return;
            }
            if (!isAuthenticated && !isAdminLocked && collection.accessCode) {
              openAccessCodeModal(index, collection.service, collection.name, collection.googleDriveLink);
              return;
            }
            displayFiles(collection.service, collection.name, collection.googleDriveLink, index);
          });
        }
      });

      // Admin-Buttons basierend auf isAuthenticated steuern
      const adminButtons = document.getElementById("adminButtons");
      if (isAuthenticated && adminButtons) {
        adminButtons.classList.remove("hidden");
      } else if (!isAuthenticated && adminButtons) {
        adminButtons.classList.add("hidden");
      }

      document.getElementById("mainCategoryAdminOnlyContainer").classList.toggle("hidden", !isAuthenticated);
      document.getElementById("editMainCategoryAdminOnlyContainer").classList.toggle("hidden", !isAuthenticated);
      document.getElementById("isAdminOnlyContainer").classList.toggle("hidden", !isAuthenticated);
      document.getElementById("editIsAdminOnlyContainer").classList.toggle("hidden", !isAuthenticated);
    };

    // Dateien f√ºr eine Kollektion abrufen
    const getFilesForCollection = (service) => {
      const credentials = JSON.parse(localStorage.getItem("credentials") || "[]");
      const serviceCredentials = credentials.filter((cred) => cred.service === service);
      let allFiles = [];
      serviceCredentials.forEach((cred) => {
        const files = cloudFiles[service]?.[cred.username] || [];
        allFiles = allFiles.concat(files.map(file => ({ ...file, username: cred.username })));
      });
      return allFiles;
    };

    // Dateien einer Kollektion anzeigen
    const displayFiles = (service, collectionName, cloudLink, collectionIndex) => {
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      const collection = collections[collectionIndex];
      const categories = loadCategories();
      const mainCategory = categories.find(cat => cat.name === collection.mainCategory);
      const isAdminLocked = collection.isAdminOnly || (mainCategory && mainCategory.isAdminOnly);

      if (isAdminLocked && !isAuthenticated) {
        alert("Nur authentifizierte Admins k√∂nnen auf diese Kollektion zugreifen!");
        return;
      }

      const collectionsList = document.getElementById("collectionsList");
      collectionsList.innerHTML = `
        <div class="col-span-full flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold">${collectionName}</h2>
          ${isAuthenticated ? `<button onclick="openEditCollectionModal(${collectionIndex}, '${collectionName}', '${service}', '${cloudLink || ''}')" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600">Bearbeiten</button>` : ''}
        </div>
      `;
      const files = getFilesForCollection(service);
      files.forEach((file) => {
        const div = document.createElement("div");
        div.className = "collection-card bg-gray-800 p-4 rounded-lg";
        div.innerHTML = `
          <img src="https://via.placeholder.com/150x200?text=${file.name}" alt="${file.name}" class="w-full h-40 object-cover rounded">
          <p class="mt-2 text-center uppercase font-semibold">${file.name}</p>
          <p class="text-center text-gray-400">Gr√∂√üe: ${file.size}</p>
          <p class="text-center text-gray-400">Account: ${file.username}</p>
          <a href="${file.url}" class="block text-center text-blue-500 underline mt-2">Download</a>
        `;
        collectionsList.appendChild(div);
      });

      if (cloudLink) {
        const serviceName = service === "googleDrive" ? "Google Drive" : service === "oneDrive" ? "OneDrive" : "Cloud";
        const div = document.createElement("div");
        div.className = "collection-card bg-gray-800 p-4 rounded-lg";
        div.innerHTML = `
          <img src="https://via.placeholder.com/150x200?text=${serviceName}" alt="${serviceName}" class="w-full h-40 object-cover rounded">
          <p class="mt-2 text-center uppercase font-semibold">${serviceName} Datei</p>
          <a href="${cloudLink}" class="block text-center text-blue-500 underline mt-2" target="_blank">Download</a>
        `;
        collectionsList.appendChild(div);
      }
    };

    // Passwort-Manager Funktionen
    const saveCredential = (service, username, password) => {
      const credentials = JSON.parse(localStorage.getItem("credentials") || "[]");
      credentials.push({ service, username, password: encrypt(password) });
      localStorage.setItem("credentials", JSON.stringify(credentials));
      displayCredentials();
    };

    const deleteCredential = (index) => {
      const credentials = JSON.parse(localStorage.getItem("credentials") || "[]");
      credentials.splice(index, 1);
      localStorage.setItem("credentials", JSON.stringify(credentials));
      displayCredentials();
    };

    const copyToClipboard = (text) => {
      navigator.clipboard.writeText(text).then(() => {
        alert("In Zwischenablage kopiert!");
      });
    };

    const displayCredentials = () => {
      const credentials = JSON.parse(localStorage.getItem("credentials") || "[]");
      const credentialList = document.getElementById("credentialList");
      const searchTerm = document.getElementById("searchCredentials").value.toLowerCase();
      const filteredCredentials = credentials.filter(cred => 
        cred.service.toLowerCase().includes(searchTerm) || 
        cred.username.toLowerCase().includes(searchTerm)
      );

      credentialList.innerHTML = "";
      filteredCredentials.forEach((cred, index) => {
        const div = document.createElement("div");
        div.className = "password-item flex items-center justify-between p-3 rounded-lg mb-2";
        div.innerHTML = `
          <div class="flex-1">
            <p class="font-semibold">${cred.service}</p>
            <p>Benutzername: ${cred.username}</p>
            <p>Passwort: <span class="password" style="display: none;">${decrypt(cred.password)}</span>
              <button class="toggle-password text-blue-500 hover:underline ml-2">üëÅÔ∏è</button>
            </p>
          </div>
          <div class="flex gap-2">
            <button class="copy-username bg-gray-200 text-gray-900 p-1 rounded-full hover:bg-gray-300" data-value="${cred.username}">
              üìã
            </button>
            <button class="copy-password bg-gray-200 text-gray-900 p-1 rounded-full hover:bg-gray-300" data-value="${decrypt(cred.password)}">
              üìã
            </button>
            <button class="delete-btn bg-red-500 text-white p-1 rounded-full hover:bg-red-600" data-index="${index}">
              üóëÔ∏è
            </button>
          </div>
        `;
        credentialList.appendChild(div);

        div.querySelector(".toggle-password").addEventListener("click", () => {
          const passwordSpan = div.querySelector(".password");
          passwordSpan.style.display = passwordSpan.style.display === "none" ? "inline" : "none";
        });

        div.querySelector(".copy-username").addEventListener("click", () => {
          copyToClipboard(cred.username);
        });

        div.querySelector(".copy-password").addEventListener("click", () => {
          copyToClipboard(decrypt(cred.password));
        });

        div.querySelector(".delete-btn").addEventListener("click", () => deleteCredential(index));
      });
    };

    // Zugriffscode-Modal Funktionen
    const accessCodeModal = document.getElementById("accessCodeModal");
    let currentAccessCollection = null;

    const openAccessCodeModal = (index, service, name, cloudLink) => {
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      const collection = collections[index];
      const categories = loadCategories();
      const mainCategory = categories.find(cat => cat.name === collection.mainCategory);
      const isAdminLocked = collection.isAdminOnly || (mainCategory && mainCategory.isAdminOnly);

      // Zugriffscode nur f√ºr nicht-admin-gesperrte Kollektionen erlauben
      if (isAdminLocked) {
        alert("Diese Kollektion ist nur f√ºr Admins zug√§nglich und kann nicht mit einem Zugriffscode entsperrt werden!");
        return;
      }

      currentAccessCollection = { index, service, name, cloudLink };
      document.getElementById("accessCodeInput").value = "";
      accessCodeModal.classList.remove("hidden");
    };

    document.getElementById("closeAccessCodeModalBtn").addEventListener("click", () => {
      accessCodeModal.classList.add("hidden");
      currentAccessCollection = null;
    });

    document.getElementById("submitAccessCodeBtn").addEventListener("click", () => {
      const enteredCode = document.getElementById("accessCodeInput").value;
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      const collection = collections[currentAccessCollection.index];
      const categories = loadCategories();
      const mainCategory = categories.find(cat => cat.name === collection.mainCategory);
      const isAdminLocked = collection.isAdminOnly || (mainCategory && mainCategory.isAdminOnly);

      if (isAdminLocked) {
        alert("Diese Kollektion ist nur f√ºr Admins zug√§nglich und kann nicht mit einem Zugriffscode entsperrt werden!");
        accessCodeModal.classList.add("hidden");
        currentAccessCollection = null;
        return;
      }

      if (enteredCode === collection.accessCode) {
        displayFiles(collection.service, collection.name, collection.googleDriveLink, currentAccessCollection.index);
        accessCodeModal.classList.add("hidden");
        currentAccessCollection = null;
      } else {
        alert("Ung√ºltiger Zugriffscode!");
      }
    });

    // Event Listener f√ºr Passwort-Manager Popup
    const passwordManagerModal = document.getElementById("passwordManagerModal");
    document.getElementById("openPasswordManagerBtn").addEventListener("click", () => {
      passwordManagerModal.classList.remove("hidden");
      displayCredentials();
    });

    document.getElementById("closePasswordManagerBtn").addEventListener("click", () => {
      passwordManagerModal.classList.add("hidden");
    });

    document.getElementById("searchCredentials").addEventListener("input", displayCredentials);

    // Event Listener f√ºr Neue Kollektion Button
    document.getElementById("openNewCollectionBtn").addEventListener("click", () => {
      updateCategoryDropdowns('new');
      document.getElementById("newCollectionModal").classList.remove("hidden");
    });

    // Event Listener f√ºr Export localStorage Button
    document.getElementById("exportLocalStorageBtn").addEventListener("click", () => {
      // Daten aus localStorage abrufen
      const categories = loadCategories();
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      const credentials = JSON.parse(localStorage.getItem("credentials") || "[]");

      // Daten in ein Objekt zusammenfassen
      const exportData = {
        categories,
        collections,
        credentials
      };

      // Daten als JSON-Datei herunterladen
      const dataStr = JSON.stringify(exportData, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "localStorage_export.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert("Die localStorage-Daten wurden als 'localStorage_export.json' heruntergeladen. Du kannst diese Datei als 'data.json' in dein GitHub-Repository hochladen!");
    });

    // Event Listener f√ºr Import localStorage Button
    document.getElementById("importLocalStorageBtn").addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importData = JSON.parse(e.target.result);
              if (importData.categories && importData.collections && importData.credentials) {
                localStorage.setItem("categories", JSON.stringify(importData.categories));
                localStorage.setItem("collections", JSON.stringify(importData.collections));
                localStorage.setItem("credentials", JSON.stringify(importData.credentials));
                alert("Daten erfolgreich importiert!");
                displayCollections();
                displayCredentials();
              } else {
                alert("Ung√ºltiges JSON-Format! Die Datei muss 'categories', 'collections' und 'credentials' enthalten.");
              }
            } catch (error) {
              alert("Fehler beim Parsen der JSON-Datei: " + error.message);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    });

    // Funktion zum Laden der Daten vom Repository
    const loadDataFromRepository = async () => {
      try {
        const response = await fetch("https://raw.githubusercontent.com/FelixWeidner/FelixWeidner.github.io/main/data.json");
        if (!response.ok) throw new Error(`Netzwerkantwort war nicht ok: ${response.status}`);
        const data = await response.json();
        if (data.categories && data.collections && data.credentials) {
          localStorage.setItem("categories", JSON.stringify(data.categories));
          localStorage.setItem("collections", JSON.stringify(data.collections));
          localStorage.setItem("credentials", JSON.stringify(data.credentials));
          console.log("Daten erfolgreich vom Repository geladen und in localStorage gespeichert.");
          displayCollections();
          displayCredentials();
        } else {
          console.warn("Repository-Daten enthalten nicht alle erforderlichen Schl√ºssel (categories, collections, credentials).");
        }
      } catch (error) {
        console.error("Fehler beim Laden der Repository-Daten:", error.message);
      }
    };

    // Event Listener f√ºr Neues Kollektion Modal
    const newCollectionModal = document.getElementById("newCollectionModal");
    window.openNewCollectionModal = () => {
      updateCategoryDropdowns('new');
      newCollectionModal.classList.remove("hidden");
    };

    document.getElementById("closeNewCollectionModalBtn").addEventListener("click", () => {
      newCollectionModal.classList.add("hidden");
    });

    document.getElementById("createCollectionBtn").addEventListener("click", () => {
      const name = document.getElementById("collectionNameInput").value;
      const service = document.getElementById("collectionServiceSelect").value;
      const cloudLink = document.getElementById("googleDriveLinkInput").value;
      const accessCode = document.getElementById("accessCodeInputNew").value.trim();
      const mainCategorySelect = document.getElementById("mainCategorySelect").value;
      const subCategorySelect = document.getElementById("subCategorySelect").value;
      const newMainCategory = document.getElementById("newMainCategoryInput").value.trim();
      const newSubCategory = document.getElementById("newSubCategoryInput").value.trim();
      const isCollectionAdminOnly = document.getElementById("isAdminOnlyCheckbox").checked;
      const mainCategory = newMainCategory || mainCategorySelect;
      const subCategory = newSubCategory || subCategorySelect;

      if (name && service) {
        saveCollection(name, service, cloudLink, mainCategory, subCategory, isCollectionAdminOnly, accessCode);
        document.getElementById("collectionNameInput").value = "";
        document.getElementById("collectionServiceSelect").value = "";
        document.getElementById("mainCategorySelect").value = "";
        document.getElementById("subCategorySelect").value = "";
        document.getElementById("newMainCategoryInput").value = "";
        document.getElementById("newSubCategoryInput").value = "";
        document.getElementById("isAdminOnlyCheckbox").checked = false;
        document.getElementById("googleDriveLinkInput").value = "";
        document.getElementById("accessCodeInputNew").value = "";
        newCollectionModal.classList.add("hidden");
      } else {
        alert("Bitte mindestens Kollektionsname und Cloud Service ausf√ºllen!");
      }
    });

    // Event Listener f√ºr Kollektion Bearbeiten Modal
    const editCollectionModal = document.getElementById("editCollectionModal");
    let currentEditIndex = null;

    window.openEditCollectionModal = (index, name, service, cloudLink) => {
      currentEditIndex = index;
      const collections = JSON.parse(localStorage.getItem("collections") || "[]");
      const collection = collections[index];
      document.getElementById("editCollectionNameInput").value = name;
      document.getElementById("editCollectionServiceSelect").value = service;
      updateCategoryDropdowns('edit');
      document.getElementById("editMainCategorySelect").value = collection.mainCategory || "";
      document.getElementById("editSubCategorySelect").value = collection.subCategory || "";
      document.getElementById("editNewMainCategoryInput").value = "";
      document.getElementById("editNewSubCategoryInput").value = "";
      document.getElementById("editGoogleDriveLinkInput").value = cloudLink || "";
      document.getElementById("editCollectionImageInput").value = "";
      document.getElementById("editIsAdminOnlyCheckbox").checked = collection.isAdminOnly || false;
      document.getElementById("editAccessCodeInput").value = collection.accessCode || "";
      editCollectionModal.classList.remove("hidden");
    };

    document.getElementById("closeEditCollectionModalBtn").addEventListener("click", () => {
      editCollectionModal.classList.add("hidden");
    });

    document.getElementById("saveCollectionBtn").addEventListener("click", () => {
      const name = document.getElementById("editCollectionNameInput").value;
      const service = document.getElementById("editCollectionServiceSelect").value;
      const cloudLink = document.getElementById("editGoogleDriveLinkInput").value;
      const imageInput = document.getElementById("editCollectionImageInput");
      const isAdminOnly = document.getElementById("editIsAdminOnlyCheckbox").checked;
      const accessCode = document.getElementById("editAccessCodeInput").value.trim();
      const mainCategorySelect = document.getElementById("editMainCategorySelect").value;
      const subCategorySelect = document.getElementById("editSubCategorySelect").value;
      const newMainCategory = document.getElementById("editNewMainCategoryInput").value.trim();
      const newSubCategory = document.getElementById("editNewSubCategoryInput").value.trim();
      const mainCategory = newMainCategory || mainCategorySelect;
      const subCategory = newSubCategory || subCategorySelect;

      if (name && service) {
        if (imageInput.files && imageInput.files[0]) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const imageData = e.target.result;
            updateCollection(currentEditIndex, name, service, cloudLink, imageData, isAdminOnly, mainCategory, subCategory, accessCode);
            editCollectionModal.classList.add("hidden");
          };
          reader.readAsDataURL(imageInput.files[0]);
        } else {
          const collections = JSON.parse(localStorage.getItem("collections") || "[]");
          const currentImage = collections[currentEditIndex]?.image || null;
          updateCollection(currentEditIndex, name, service, cloudLink, currentImage, isAdminOnly, mainCategory, subCategory, accessCode);
          editCollectionModal.classList.add("hidden");
        }
      } else {
        alert("Bitte mindestens Kollektionsname und Cloud Service ausf√ºllen!");
      }
    });

    // Event Listener f√ºr Passwort-Manager
    document.getElementById("addCredentialBtn").addEventListener("click", () => {
      const service = document.getElementById("serviceInput").value;
      const username = document.getElementById("usernameInput").value;
      const password = document.getElementById("passwordInput").value;
      if (service && username && password) {
        saveCredential(service, username, password);
        document.getElementById("serviceInput").value = "";
        document.getElementById("usernameInput").value = "";
        document.getElementById("passwordInput").value = "";
      } else {
        alert("Bitte alle Felder ausf√ºllen!");
      }
    });

    // Login-Modal Funktionen
    const loginModal = document.getElementById("loginModal");
    const openLoginModal = () => {
      loginModal.classList.remove("hidden");
    };

    document.getElementById("closeLoginModalBtn").addEventListener("click", () => {
      loginModal.classList.add("hidden");
    });

    document.getElementById("loginBtn").addEventListener("click", () => {
      const username = document.getElementById("loginUsernameInput").value;
      const password = document.getElementById("loginPasswordInput").value;
      if (username === "seasonedcoder11" && password === "2$c3!cW9yv#GX4@r") {
        isAuthenticated = true;
        alert("Erfolgreich angemeldet!");
        loginModal.classList.add("hidden");
        displayCollections();
      } else {
        alert("Ung√ºltiger Benutzername oder Passwort!");
      }
    });

    // Tastenkombination Alt+Shift+H f√ºr Admin-Buttons
    document.addEventListener("keydown", (event) => {
      if (event.altKey && event.shiftKey && event.key.toLowerCase() === "h") {
        event.preventDefault(); // Verhindert Standardverhalten des Browsers
        const adminButtons = document.getElementById("adminButtons");
        adminButtons.classList.toggle("hidden");
        console.log("Admin-Buttons Sichtbarkeit gewechselt:", !adminButtons.classList.contains("hidden"));
      }
    });

    // Initiale Anzeige der Kollektionen und Daten vom Repository laden
    loadDataFromRepository();
    displayCollections();
  </script>
</body>
</html>
